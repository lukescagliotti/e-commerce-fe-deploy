import{a as n}from"./chunk-4DB2YMOA.js";import{e as f}from"./chunk-WB4KDGBB.js";import{Eb as h,O as l,T as a,Vb as u,c as s,ma as c,p as o}from"./chunk-NPZXHD37.js";var U=(()=>{class i{http;router;currentUser=c(null);loading=c(!1);user=this.currentUser.asReadonly();isLoading=this.loading.asReadonly();isAuthenticated=h(()=>!!this.currentUser());isAdmin=h(()=>this.currentUser()?.role==="admin");constructor(e,t){this.http=e,this.router=t}getToken(){return localStorage.getItem("accessToken")}setToken(e){e?localStorage.setItem("accessToken",e):localStorage.removeItem("accessToken")}getRefreshToken(){return localStorage.getItem("refreshToken")}setRefreshToken(e){e?localStorage.setItem("refreshToken",e):localStorage.removeItem("refreshToken")}isTokenExpiringSoon(){let e=this.getToken();if(!e)return!1;try{return JSON.parse(atob(e.split(".")[1])).exp*1e3-Date.now()<6e4}catch{return!1}}refreshSession(){return s(this,null,function*(){let e=this.getRefreshToken();if(!e)return!1;try{let t=yield o(this.http.post(`${n.apiUrl}/auth/refresh`,{refreshToken:e}));return this.setToken(t.accessToken),this.setRefreshToken(t.refreshToken),!0}catch{return!1}})}loadUser(){return s(this,null,function*(){if(this.getToken()){this.loading.set(!0);try{let t=yield o(this.http.get(`${n.apiUrl}/auth/me`));this.currentUser.set(t)}catch{this.currentUser.set(null)}finally{this.loading.set(!1)}}})}login(e,t){return s(this,null,function*(){let r=yield o(this.http.post(`${n.apiUrl}/auth/login`,{email:e,password:t}));return this.setToken(r.accessToken),r.refreshToken&&this.setRefreshToken(r.refreshToken),r.customer?this.currentUser.set(r.customer):yield this.loadUser(),r})}register(e){return s(this,null,function*(){return o(this.http.post(`${n.apiUrl}/auth/register`,e))})}logout(){return s(this,null,function*(){try{yield o(this.http.post(`${n.apiUrl}/auth/signout`,{}))}catch{}finally{this.setToken(null),this.setRefreshToken(null),this.currentUser.set(null),this.router.navigateByUrl("/")}})}getMe(){return s(this,null,function*(){let e=yield o(this.http.get(`${n.apiUrl}/auth/me`));return this.currentUser.set(e),e})}static \u0275fac=function(t){return new(t||i)(a(u),a(f))};static \u0275prov=l({token:i,factory:i.\u0275fac,providedIn:"root"})}return i})();export{U as a};
